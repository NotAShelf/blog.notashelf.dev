<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="generator" content="pandoc" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, user-scalable=yes"
		/>
		   		<meta name="description" content="NotAShelf's notes on various topics" />
				<title>Posts - Extended Nixpkgs</title>
		<style>
			code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
/* The extra [class] is a hack that increases specificity enough to
   override a similar rule in reveal.js */
ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
  font-size: inherit;
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #232629;
    color: #7a7c7d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
div.sourceCode
  { color: #cfcfc2;  }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #cfcfc2; } /* Normal */
code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
code span.an { color: #3f8058; } /* Annotation */
code span.at { color: #2980b9; } /* Attribute */
code span.bn { color: #f67400; } /* BaseN */
code span.bu { color: #7f8c8d; } /* BuiltIn */
code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #3daee9; } /* Char */
code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
code span.co { color: #7a7c7d; } /* Comment */
code span.cv { color: #7f8c8d; } /* CommentVar */
code span.do { color: #a43340; } /* Documentation */
code span.dt { color: #2980b9; } /* DataType */
code span.dv { color: #f67400; } /* DecVal */
code span.er { color: #da4453; text-decoration: underline; } /* Error */
code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
code span.fl { color: #f67400; } /* Float */
code span.fu { color: #8e44ad; } /* Function */
code span.im { color: #27ae60; } /* Import */
code span.in { color: #c45b00; } /* Information */
code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
code span.op { color: #cfcfc2; } /* Operator */
code span.ot { color: #27ae60; } /* Other */
code span.pp { color: #27ae60; } /* Preprocessor */
code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #da4453; } /* SpecialString */
code span.st { color: #f44f4f; } /* String */
code span.va { color: #27aeae; } /* Variable */
code span.vs { color: #da4453; } /* VerbatimString */
code span.wa { color: #da4453; } /* Warning */
		</style>
				<link rel="stylesheet" href="/home/runner/work/blog.notashelf.dev/blog.notashelf.dev/templates/style.css" />
				<!-- Begin Lineicons import -->
		<link
			rel="stylesheet"
			href="https://cdn.lineicons.com/4.0/lineicons.css"
		/>
		<!-- End Lineicons import-->
		<link rel="stylesheet" href="/style.css" />
	</head>
	<body>
		<header>
			<nav class="primary-buttons">
				<ul>
					<li><a class="nav-button" href="/">Index</a></li>
				</ul>
			</nav>
			<nav class="secondary-buttons">
				<ul>
					<li>
						<div class="dropdown">
							<button class="nav-button">Posts</button>
							<div
								class="dropdown-content"
								id="dropdown-content"
							></div>
						</div>
						<a class="nav-button" href="/pages/about.html">
							About
						</a>
						<a class="nav-button" href="/pages/privacy.html">
							Privacy
						</a>
					</li>
				</ul>
			</nav>
		</header>

		<main>
						<nav id="TOC" role="doc-toc">
				 <ul>
<li><a href="#when-why-and-how-to-extend-nixpkgs-standard-library"
id="toc-when-why-and-how-to-extend-nixpkgs-standard-library">When, why
and how to extend nixpkgs standard library</a>
<ul>
<li><a href="#what-is-nixpkgslib" id="toc-what-is-nixpkgslib">What is
<code>nixpkgs.lib</code></a></li>
<li><a href="#why-would-you-need-to-extend-nixpkgslib"
id="toc-why-would-you-need-to-extend-nixpkgslib">Why would you need to
extend <code>nixpkgs.lib</code></a></li>
<li><a href="#extending-nixpkgslib"
id="toc-extending-nixpkgslib">Extending
<code>nixpkgs.lib</code></a></li>
</ul></li>
</ul>
			</nav>
			 <h1 id="when-why-and-how-to-extend-nixpkgs-standard-library">When, why
and how to extend nixpkgs standard library</h1>
<p>Those are my notes on extending nixpkgs with your own functions and
abstractions. There may be other ways of doing it, but this is the one I
find to be most ergonomic.</p>
<h2 id="what-is-nixpkgslib">What is <code>nixpkgs.lib</code></h2>
<p>In the context of the Nix package manager and NixOS,
<code>nixpkgs.lib</code> refers to a module within the Nixpkgs
repository. The <code>nixpkgs.lib</code> module provides a set of
utility functions and definitions that are commonly used across the
Nixpkgs repository. It contains various helper functions and
abstractions that make it easier to write Nix expressions and define
packages. We often use those functions to simplify our configurations
and the nix package build processes.</p>
<h2 id="why-would-you-need-to-extend-nixpkgslib">Why would you need to
extend <code>nixpkgs.lib</code></h2>
<p>While the library functions provided by nixpkgs is quite extensive
and usually suits my needs, I sometimes feel the need to define my own
function or wrap an existing function to complete a task. Normally we
can handle the process of a function inside a simple <code>let in</code>
and be well off, but there may be times you need to re-use the existing
function across your configuration file.</p>
<p>In such times, you might want to either write your own lib and
inherit it at the source of your <code>flake.nix</code> to then inherit
them across your configuration.</p>
<p>Today's notes document the process of doing exactly that.</p>
<h2 id="extending-nixpkgslib">Extending <code>nixpkgs.lib</code></h2>
<p>I find the easiest way of extending nixpkgs.lib to be using an
overlay.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lib/default.nix</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">nixpkgs</span><span class="op">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">lib</span><span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span><span class="op">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>: nixpkgs.lib.extend <span class="op">(</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">final</span><span class="op">:</span> <span class="va">prev</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># your functions go here</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">)</span></span></code></pre></div>
<p>The above structure takes the existing <code>lib</code> from
<code>nixpkgs</code>, and appends your own configurations to it. You may
then import this library in your <code>flake.nix</code> to pass it to
other imports and definitions.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flake.nix</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>flake = <span class="kw">let</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extended nixpkgs lib, contains my custom functions</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">lib</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./lib</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs lib inputs<span class="op">;};</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># entry-point for nixos configurations</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixosConfigurations</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./hosts</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs self lib<span class="op">;};</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>In this example (see my <code>flake.nix</code> for the actual
implementation) I import my extended lib from
<code>lib/default.nix</code>, where I defined the overlay. I then pass
the extended lib to my <code>nixosConfiguratiÄ±ns</code>, which is an
entry-point for all of my NixOS configurations. As such, I am able to
re-use my own utility functions across my system as I see fit.</p>
<p>The problem with this approach is that it may be confusing for other
people reviewing your configuration. With this approach,
<code>lib.customFunction</code> looks identical to any lib function,
which may lead to people thinking the function exists in nixpkgs itself
while it is only provided by your configuration. The solution for that
is simple though, instead of extending <code>nixpkgs.lib</code>, you may
define your own lib that does not inherit from <code>nixpkgs.lib</code>
and only contains your functions. The process would be similar, and you
would not need to define an overlay.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flake.nix</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>flake = <span class="kw">let</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extended nixpkgs lib, contains my custom functions</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">lib&#39;</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./lib</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs lib inputs<span class="op">;};</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># entry-point for nixos configurations</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixosConfigurations</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./hosts</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs self lib&#39;<span class="op">;};</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>where your <code>lib/default.nix</code> looks like</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lib/default.nix</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">nixpkgs</span><span class="op">,</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">lib</span><span class="op">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span><span class="op">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>: <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># your functions here</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>You can find a real life example of the alternative approach in my <a
href="https://github.com/NotAShelf/neovim-flake/blob/main/lib/stdlib-extended.nix">neovim-flake's
lib</a>.</p> 
		</main>
		<footer>
			<div class="footer-divider"></div>
			<p>&copy; <span id="copyright"></span> NotAShelf</p>
			<div class="footer-icons">
				<a href="https://github.com/notashelf">
					<i class="lni lni-github-original" title="GitHub"></i>
				</a>
			</div>
		</footer>
		<script>
			// Update the copyright text
			const currentYear = new Date().getFullYear();
			const copyrightYear =
				currentYear !== 2024 ? "2024 - " + currentYear : "2024";

			document.getElementById("copyright").textContent = copyrightYear;

			// Dropdown post listing
			function fetchPosts() {
				fetch("/posts/posts.json")
					.then((response) => response.json())
					.then((data) => {
						const dropdownContent =
							document.getElementById("dropdown-content");
						data.posts.forEach((post) => {
							const postLink = document.createElement("a");
							postLink.textContent = post.title;
							// we could use posts.url here, instead of posts.path
							// but it messes with local serving, which prefers `/`
							// to the actual URL, as it would point to the live site
							// by path
							postLink.href = post.path;
							dropdownContent.appendChild(postLink);
						});
					})
					.catch((error) =>
						console.error("Error fetching posts:", error),
					);
			}

			document.addEventListener("DOMContentLoaded", () => {
				fetchPosts();
			});
		</script>
	</body>
</html>
