<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/assets/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/assets/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/assets/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/assets/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/assets/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/assets/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/assets/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/assets/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/assets/android-icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/assets/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
         <meta name="dcterms.date" content="2025-03-31" />
          <meta name="description" content="A quick look into Nixï¿½ï¿½ï¿½s ï¿½ï¿½ï¿½controversialï¿½ï¿½ï¿½ nixConfig settings" />
        <title>What is nixConfig, Should You Trust It?</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #1a1c1f;
          color: #6a6c6d;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #6a6c6d;  padding-left: 4px; }
      div.sourceCode
        { color: #d8d8cc;  }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #d8d8cc; } /* Normal */
      code span.al { color: #85ca3c; background-color: #401a1f; font-weight: bold; } /* Alert */
      code span.an { color: #307048; } /* Annotation */
      code span.at { color: #1a70a9; } /* Attribute */
      code span.bn { color: #e06500; } /* BaseN */
      code span.bu { color: #6f7c7d; } /* BuiltIn */
      code span.cf { color: #edb036; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #2d9ed9; } /* Char */
      code span.cn { color: #1a9e9e; font-weight: bold; } /* Constant */
      code span.co { color: #6a6c6d; } /* Comment */
      code span.cv { color: #6f7c7d; } /* CommentVar */
      code span.do { color: #942330; } /* Documentation */
      code span.dt { color: #1a70a9; } /* DataType */
      code span.dv { color: #e06500; } /* DecVal */
      code span.er { color: #c03443; text-decoration: underline; } /* Error */
      code span.ex { color: #0080d9; font-weight: bold; } /* Extension */
      code span.fl { color: #e06500; } /* Float */
      code span.fu { color: #7c34a0; } /* Function */
      code span.im { color: #20a050; } /* Import */
      code span.in { color: #b54800; } /* Information */
      code span.kw { color: #d8d8cc; font-weight: bold; } /* Keyword */
      code span.op { color: #d8d8cc; } /* Operator */
      code span.ot { color: #20a050; } /* Other */
      code span.pp { color: #20a050; } /* Preprocessor */
      code span.re { color: #1a70a9; background-color: #0d2030; } /* RegionMarker */
      code span.sc { color: #2d9ed9; } /* SpecialChar */
      code span.ss { color: #c03443; } /* SpecialString */
      code span.st { color: #e83c3c; } /* String */
      code span.va { color: #1a9e9e; } /* Variable */
      code span.vs { color: #c03443; } /* VerbatimString */
      code span.wa { color: #c03443; } /* Warning */
    </style>
        <link rel="stylesheet" href="/style.css" />
        <!-- Begin Lineicons import -->
    <link rel="stylesheet" href="https://cdn.lineicons.com/5.0/lineicons.css" />
    <!-- End Lineicons import-->
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="shortcut icon"
      href="/assets/favicon-96x96.png"
      type="image/x-icon"
    />
  </head>
  <body>
    <header class="page-navigation">
      <nav class="primary-buttons">
        <ul>
          <li><a class="nav-button" href="/">Index</a></li>
        </ul>
      </nav>
      <nav class="secondary-buttons">
        <ul>
          <li>
            <a class="nav-button" href="/posts"> Posts </a>
            <a class="nav-button" href="/about.html"> About </a>
            <a class="nav-button" href="/privacy.html"> Privacy </a>
          </li>
        </ul>
      </nav>
    </header>
    <hr class="nav-border">

    <main>
      <!-- Keywords, if any. -->
      

      <!-- Table of Contents, if enabled -->
       <h1 id="what-is-nixconfig-and-should-you-trust-it">What is
nixConfig, and Should You Trust It?</h1>
<div class="reading-time">
<p>4 minute read</p>
</div>
<p>Those of you who have been a part of the Nix ecosystem, more
specifically the community that often deals with flakes,<a href="#fn1"
class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>
have no doubt noticed or perhaps actively use the <code>nixConfig</code>
attribute in a <code>flake.nix</code>. For those unfamiliar, the NixOS
wiki in the <a
href="https://wiki.nixos.org/wiki/Flakes#Flake_schema">article on
flakes</a> defines it as follows:</p>
<blockquote>
<p><code>nixConfig</code> is an attribute set of values which reflect
the values given to nix.conf. This can extend the normal behavior of a
userâ€™s nix experience by adding flake-specific configuration, such as a
binary cache.</p>
</blockquote>
<p>Sounds good, right? Wrong. It is a ticking time bomb waiting to
explode. Being able to modify your <code>nix.conf</code> on your system
is equivalent to having full control of the Nix daemon. When you check
out a repository that uses flakes and run, say, <code>nix run</code> on
a package, you will get a prompt asking whether you trust the
configuration settings set in the flake.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>$ nix run .<span class="co">#foobar</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>do you want to allow configuration setting &#39;extra<span class="op">-</span>substituters&#39; to be set to &#39;<span class="va">https</span><span class="op">://</span>nix<span class="op">-</span>community.cachix.org&#39; <span class="op">(</span><span class="ss">y/N</span><span class="op">)?</span> y</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>do you want to permanently mark this value as trusted <span class="op">(</span><span class="ss">y/N</span><span class="op">)?</span> y</span></code></pre></div>
<p>Accept it, and the door is wide open. More technical users may
object, saying they will know the changes being made to their system.
They are not wrong, but if that is their argument, then they are
incredibly dense.</p>
<h2 id="security-implications" id="security-implications">Security
Implications <a href="#security-implications" class="anchor-link">ðŸ”—</a></h2>
<p>You should be fully aware that changes made through
<code>nixConfig</code> will affect all Nix operations within the flake,
possibly increasing the attack surface through the introduction of
unsafe, unsigned, and malicious binary caches. It can also introduce
<code>allowUnfree</code>, which might cause ideological or legal
(<em>see: licensing</em>) issues depending on the context.</p>
<p><code>nixConfig</code> is a powerful option that can modify settings
you do not want changed haphazardlyâ€”from package sources to substitution
and trusted keys your build process will use. Oftentimes, this option is
more of a hassle than a convenience, though some might find it
incredibly useful.</p>
<p>There exists an <code>accept-flake-config</code> option that you can
set as <code>nix.settings.accept-flake-config</code>. Keep this set to
<em>false</em>, as automatically accepting those optionsâ€”without the
prompt aboveâ€”is more insecure than you think. There are <em>many</em>
vulnerabilities that can come from blindly trusting a flakeâ€™s
<code>nixConfig</code>.</p>
<p>If you want to go a step further, I have been running the following
patch by the awesome <a
href="https://github.com/eclairevoyant">@eclairevoyant</a> to add a
<em>reject-flake-config</em> option to <a
href="https://lix.systems">Lix, the Nix fork</a>, to automatically
reject flakesâ€™ <code>nixConfig</code>.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode diff"><code class="sourceCode diff"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>From 25f1b8e714b13d2aa6fcdc67bedf1544bd17e45a Mon Sep 17 00:00:00 2001</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>From: =?UTF-8?q?=C3=A9clairevoyant?= &lt;848000+eclairevoyant@users.noreply.github.com&gt;</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Date: Fri, 19 Jul 2024 09:23:27 -0400</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Subject: [PATCH 3/4] feat: option reject-flake-config</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">---</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>src/libexpr/flake/config.cc       | 5 +++++</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>src/libfetchers/fetch-settings.hh | 4 ++++</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="dt">2 files changed, 9 insertions(+)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">diff --git a/src/libexpr/flake/config.cc b/src/libexpr/flake/config.cc</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>index 558b3e9b9..bf558e5e2 100644</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/src/libexpr/flake/config.cc</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/src/libexpr/flake/config.cc</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -51,6 +51,11 @@ void ConfigFile::apply()</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>         else</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>             assert(false);</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="va">+        if (nix::fetchSettings.rejectFlakeConfig) {</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="va">+            warn(&quot;ignoring untrusted flake configuration setting &#39;%s&#39; due to the &#39;%s&#39; setting.&quot;, name, &quot;reject-flake-config&quot;);</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="va">+            continue;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="va">+        }</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>         bool trusted = whitelist.count(baseName);</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>         if (!trusted) {</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>             switch (nix::fetchSettings.acceptFlakeConfig.get()) {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="kw">diff --git a/src/libfetchers/fetch-settings.hh b/src/libfetchers/fetch-settings.hh</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>index 93123463c..67f2e4d14 100644</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/src/libfetchers/fetch-settings.hh</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/src/libfetchers/fetch-settings.hh</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -108,6 +108,10 @@ struct FetchSettings : public Config</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        )&quot;,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        {}, true, Xp::Flakes};</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="va">+    Setting&lt;bool&gt; rejectFlakeConfig{this, false, &quot;reject-flake-config&quot;,</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="va">+        &quot;Whether to reject nix configuration (including whitelisted settings) from a flake without prompting.&quot;,</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="va">+        {}, true, Xp::Flakes};</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    Setting&lt;std::string&gt; commitLockFileSummary{</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        this, &quot;&quot;, &quot;commit-lockfile-summary&quot;,</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        R&quot;(</span></code></pre></div>
<p>Give it a try if you are running Lix and donâ€™t mind the rebuilds.
This will reject the flake config, skipping the prompt to accept the
values set in <code>nixConfig</code>.</p>
<h2 id="looking-into-nixconfig" id="looking-into-nixconfig">Looking into
nixConfig <a href="#looking-into-nixconfig" class="anchor-link">ðŸ”—</a></h2>
<p>Now that the ultimatum is out of the way, letâ€™s take a look at what
<code>nixConfig</code> is and what it really does. As mentioned above,
it is <em>an attribute set of values that reflect the values given to
nix.conf.</em> That in itself is a vague explanation, but it gets the
point across: it is an attribute set that takes the same values you
would pass to <code>nix.settings</code>, which are used to construct the
<code>nix.conf</code> in a typical NixOS configuration. Or, if you are
using Nix standalone, it is an attribute set of values that would be
converted to their <code>nix.conf</code> equivalents.</p>
<p>It is defined and used in <a
href="https://github.com/NixOS/nix/blob/92c4789ec72a5bf485679f9a5e5a244e553fb03d/src/libflake/flake/config.cc."><code>libflake/flake/config.cc</code></a>,
and according to the <code>getDataDir()</code> function, this retrieves
the full path of Nixâ€™s data directory (one of
<code>NIX_DATA_DIRECTORY</code>, <code>XDG_DATA_HOME</code>, or
<code>$HOME/.local/share/nix/</code> in that order) and creates
<code>trusted-settings.json</code>.</p>
<p>Nice. Now we know where to look if we <em>accidentally</em> accept
the prompt or ever want to retract our blind trust in a flakeâ€™s
author.</p>
<h2 id="conclusion"
id="conclusion">Conclusion <a href="#conclusion" class="anchor-link">ðŸ”—</a></h2>
<p>Other than this path, there is not much to <code>nixConfig</code>.
Your system does not interact with it until you enter the directory of a
flake and run a command that triggers evaluation, in which case <a
href="https://github.com/NixOS/nix/blob/92c4789ec72a5bf485679f9a5e5a244e553fb03d/src/libflake/flake/config.cc#L32C1-L79C2"><code>ConfigFile::apply</code></a>
is invoked.</p>
<p>In short, <code>nixConfig</code> is a powerful attribute that <em>may
or may not come in handy</em> at the cost of exposing a very large
attack vector. Even a lazy attacker can exploit it, and the user is not
properly warned about the consequences of accepting the prompt (which
defaults to true for some reason).</p>
<p>This has been your ever-so-informative technical rant on Nix and its
undocumented mess. Hope you learned something today. Cheers.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>If you donâ€™t use Nix flakes or have no idea what they
are, then this post does not apply to you. In fact, Iâ€™m glad youâ€™re
saving yourself the headache!<a href="#fnref1" class="footnote-back"
role="doc-backlink">â†©ï¸Ž</a></p></li>
</ol>
</section> 
    </main>
    <footer>
      <div class="footer-divider"></div>
      <p>&copy; <span id="copyright"></span> NotAShelf</p>
      <div class="footer-icons">
        <a href="https://github.com/notashelf">
          <i class="lni lni-github" title="GitHub"></i>
        </a>
      </div>
    </footer>
    <script defer src="/static/scripts/copyright.js"</script>
    <script
        defer
      data-domain="blog.notashelf.dev"
      src="https://pl.notashelf.dev/js/script.file-downloads.hash.outbound-links.tagged-events.js"
    ></script>
    <script>
      window.plausible =
        window.plausible ||
        function () {
          (window.plausible.q = window.plausible.q || []).push(arguments);
        };
    </script>

        </body>
</html>
