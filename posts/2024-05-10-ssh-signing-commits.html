<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/assets/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/assets/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/assets/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/assets/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/assets/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/assets/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/assets/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/assets/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/assets/android-icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/assets/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
         <meta name="dcterms.date" content="2024-05-10" />
          <meta name="description" content="Notes on Nix, Linux and every other pie I put a finger in" />
        <title>Posts - Ssh Signing Commits</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #232629;
          color: #7a7c7d;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
      div.sourceCode
        { color: #cfcfc2;  }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #cfcfc2; } /* Normal */
      code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
      code span.an { color: #3f8058; } /* Annotation */
      code span.at { color: #2980b9; } /* Attribute */
      code span.bn { color: #f67400; } /* BaseN */
      code span.bu { color: #7f8c8d; } /* BuiltIn */
      code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #3daee9; } /* Char */
      code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
      code span.co { color: #7a7c7d; } /* Comment */
      code span.cv { color: #7f8c8d; } /* CommentVar */
      code span.do { color: #a43340; } /* Documentation */
      code span.dt { color: #2980b9; } /* DataType */
      code span.dv { color: #f67400; } /* DecVal */
      code span.er { color: #da4453; text-decoration: underline; } /* Error */
      code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
      code span.fl { color: #f67400; } /* Float */
      code span.fu { color: #8e44ad; } /* Function */
      code span.im { color: #27ae60; } /* Import */
      code span.in { color: #c45b00; } /* Information */
      code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
      code span.op { color: #cfcfc2; } /* Operator */
      code span.ot { color: #27ae60; } /* Other */
      code span.pp { color: #27ae60; } /* Preprocessor */
      code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
      code span.sc { color: #3daee9; } /* SpecialChar */
      code span.ss { color: #da4453; } /* SpecialString */
      code span.st { color: #f44f4f; } /* String */
      code span.va { color: #27aeae; } /* Variable */
      code span.vs { color: #da4453; } /* VerbatimString */
      code span.wa { color: #da4453; } /* Warning */
    </style>
        <link rel="stylesheet" href="/home/runner/work/blog.notashelf.dev/blog.notashelf.dev/templates/style.css" />
        <!-- Begin Lineicons import -->
    <link rel="stylesheet" href="https://cdn.lineicons.com/4.0/lineicons.css" />
    <!-- End Lineicons import-->
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="shortcut icon"
      href="/assets/favicon-96x96.png"
      type="image/x-icon"
    />
  </head>
  <body>
    <header class="page-navigation">
      <nav class="primary-buttons">
        <ul>
          <li><a class="nav-button" href="/">Index</a></li>
        </ul>
      </nav>
      <nav class="secondary-buttons">
        <ul>
          <li>
            <a class="nav-button" href="/pages/posts.html"> Posts </a>
            <a class="nav-button" href="/pages/about.html"> About </a>
            <a class="nav-button" href="/pages/privacy.html"> Privacy </a>
          </li>
        </ul>
      </nav>
    </header>
    <hr class="nav-border">

    <main>
      <!-- Keywords, if any. -->
      

      <!-- Table of Contents, if enabled -->
       <h1 id="signing-git-commits-with-ssh-keys">Signing Git commits
with SSH keys</h1>
<h2 id="resources">Resources</h2>
<ul>
<li><a
href="https://blog.gitbutler.com/git-tips-and-tricks/">https://blog.gitbutler.com/git-tips-and-tricks/</a></li>
</ul>
<h2 id="setting-up-ssh-signing-for-git-commits">Setting up SSH signing
for Git commits</h2>
<p>For the longest of times, I have been running an obscure GPG setup
that requires me to go back to my notes every time I wish to replicate
it on a new machine or a friend's machine to help them set up GPG
signing on their system. Today, after roughly 6 years of pushing GPG
signed commits, I have learned about SSH signing<a href="#fn1"
class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>,
and have decided to share my notes on setting it up.</p>
<blockquote>
<p>A basic prerequisite is that you need your SSH key pair added to the
Git service you will be using e.g., Github or Forgejo, so that you are
able to push and pull via SSH. <a
href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">Github
Documentation</a> on SSH keys shows you how to set that up, and I
imagine other platforms are not that more complicated.</p>
</blockquote>
<h3 id="traditional-distros">Traditional Distros</h3>
<p>If you are using a traditional distribution like Fedora or Arch<a
href="#fn2" class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a> then the setup consists of two
commands:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> config <span class="at">--global</span> gpg.format ssh <span class="co"># tell Git to use SSH signing keys</span></span></code></pre></div>
<p>Followed by the command to tell Git which key to use:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> config <span class="at">--global</span> user.signingkey ~/.ssh/my-key.pub</span></code></pre></div>
<p>If you wish to sign commits of a specific repository, then you may
run the above command in said repository and omit <code>--global</code>
to store the local (repository) configuration in <code>.git/</code>
directory of the repository you can the command in.</p>
<blockquote>
<p>Remember to replace the example path I've used above with the path to
your <strong>public</strong> key.</p>
</blockquote>
<p>Now it is time to tell Github about your signing key. Add your public
key to Github again, but this time change the key type to "Signing Key".
The process should once again be similar for other public Git
services.</p>
<p>Last, you will want to actually use the signing key that you have
configured Git to use for <em>signed</em> commits. That's right, all
commits are unsigned until you either pass <code>-S</code> to
<code>git commit</code> or set
<code>git config --global commit.gpgsign true</code>. Similarly, you can
also sign selected tags with <code>git tag -s</code>. To sign
<em>all</em> git tags, you must run
<code>git config --global tag.gpgsign true</code>, or the same command
without <code>--global</code> to sign tags in a local repository.</p>
<h3 id="on-nixos">On NixOS</h3>
<p>In typical NixOS fashion, such a trivial process is mind-numbingly
easy. You will want to configure <code>programs.git</code> under either
NixOS or Home-Manager module systems. As Git is rather a userspace
application, I choose to use the one under home-manager but NixOS also
allows you to configure git globally with <code>/etc/gitconfig</code>
being used.</p>
<p>First you would like to add <code>programs.git.signing</code> to your
home.nix as follows:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># home.nix</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>programs.git = <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">signing</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">key</span> <span class="op">=</span> <span class="st">&quot;</span><span class="sc">${</span>config.home.homeDirectory<span class="sc">}</span><span class="st">/.ssh/my-key.pub&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    signByDefault = <span class="cn">true</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">extraConfig</span>.<span class="va">gpg</span>.<span class="va">format</span> <span class="op">=</span> <span class="st">&quot;ssh&quot;</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>and this will be enough to tell Git where to look while also setting
<code>signByDefault</code>, meaning all of your commits will be signed.
Great!</p>
<p>If you wish to take this a bit further, you may consider setting
allowed signers to decide who can and cannot sign using the
<code>ssh.allowedSignersFile</code> option under
<code>extraConfig.gpg</code>. Do keep in mind, however, that you need to
have set an allowed signers file beforehand. To do so, expand your
<code>home.nix</code> with the new options:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># home.nix</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span><span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="op">...}</span>: <span class="kw">let</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">key</span> <span class="op">=</span> <span class="st">&quot;&lt;your public key&gt;&quot;</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">email</span> <span class="op">=</span> <span class="st">&quot;&lt;your email&gt;&quot;</span><span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write signersFile to /nix/store/&lt;store path&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">signersFile</span> <span class="op">=</span> pkgs.writeText <span class="st">&quot;git-allowed-signers&quot;</span> <span class="st">&#39;&#39;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="st">    </span><span class="sc">${</span>email<span class="sc">}</span><span class="st"> namespaces=&quot;git&quot; </span><span class="sc">${</span>key<span class="sc">}</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span><span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> <span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">xdg</span>.<span class="va">configFile</span>.<span class="st">&quot;</span>git/allowed_signers<span class="st">&quot;</span>.<span class="va">text</span> <span class="op">=</span> signersFile<span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">programs</span>.<span class="va">git</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">signing</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>      <span class="va">key</span> <span class="op">=</span> <span class="st">&quot;</span><span class="sc">${</span>config.home.homeDirectory<span class="sc">}</span><span class="st">/.ssh/my-key.pub&quot;</span><span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">signByDefault</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">extraConfig</span>.<span class="va">gpg</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      <span class="va">format</span> <span class="op">=</span> <span class="st">&quot;ssh&quot;</span><span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      <span class="va">ssh</span>.<span class="va">allowedSignersFile</span> <span class="op">=</span> signersFile<span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>In above example, we have written a symlink to
<code>~/.config/git/allowed_signers</code> using
<code>xdg.configFile</code> and <code>pkgs.writeText</code>. Then,
<code>programs.git.extraConfig.gpg.ssh.allowedSignersFile</code> tells
Git which users will be allowed to sign commits based on commit
email.</p>
<p>And that is all! You may now switch Home-Manager generations with
either <code>nixos-rebuild switch</code> (if you have Home-Manager as a
NixOS module) or <code>home-manager switch</code> (if you are using
home-manager in standalone mode). Do make sure to adapt the example to
your own setup.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>To be fair, I have known about SSH signing for a while
now, but the sunk-cost fallacy has prevented me from ever looking into
it. As a matter of fact, I am still not convinced by it, but that is
because I still use a Yubikey based GPG setup which partially obsoletes
SSH signing and prevents me from looking further into the matter.
Regardless, this documents my experience with SSH signing, so I may
return anytime.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Please don't.<a href="#fnref2" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
</ol>
</section> 
    </main>
    <footer>
      <div class="footer-divider"></div>
      <p>&copy; <span id="copyright"></span> NotAShelf</p>
      <div class="footer-icons">
        <a href="https://github.com/notashelf">
          <i class="lni lni-github-original" title="GitHub"></i>
        </a>
      </div>
    </footer>
    <script src="/static/copyright.js"</script>
  </body>
</html>
