<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/assets/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/assets/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/assets/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/assets/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/assets/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/assets/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/assets/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/assets/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/assets/android-icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/assets/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
         <meta name="dcterms.date" content="2025-02-01" />
          <meta name="description" content="Notes on Nix, Linux and every other pie I put a finger in" />
        <title>Posts - Extended Nixpkgs Lib</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #232629;
          color: #7a7c7d;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
      div.sourceCode
        { color: #cfcfc2;  }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #cfcfc2; } /* Normal */
      code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
      code span.an { color: #3f8058; } /* Annotation */
      code span.at { color: #2980b9; } /* Attribute */
      code span.bn { color: #f67400; } /* BaseN */
      code span.bu { color: #7f8c8d; } /* BuiltIn */
      code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #3daee9; } /* Char */
      code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
      code span.co { color: #7a7c7d; } /* Comment */
      code span.cv { color: #7f8c8d; } /* CommentVar */
      code span.do { color: #a43340; } /* Documentation */
      code span.dt { color: #2980b9; } /* DataType */
      code span.dv { color: #f67400; } /* DecVal */
      code span.er { color: #da4453; text-decoration: underline; } /* Error */
      code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
      code span.fl { color: #f67400; } /* Float */
      code span.fu { color: #8e44ad; } /* Function */
      code span.im { color: #27ae60; } /* Import */
      code span.in { color: #c45b00; } /* Information */
      code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
      code span.op { color: #cfcfc2; } /* Operator */
      code span.ot { color: #27ae60; } /* Other */
      code span.pp { color: #27ae60; } /* Preprocessor */
      code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
      code span.sc { color: #3daee9; } /* SpecialChar */
      code span.ss { color: #da4453; } /* SpecialString */
      code span.st { color: #f44f4f; } /* String */
      code span.va { color: #27aeae; } /* Variable */
      code span.vs { color: #da4453; } /* VerbatimString */
      code span.wa { color: #da4453; } /* Warning */
    </style>
        <link rel="stylesheet" href="/home/runner/work/blog.notashelf.dev/blog.notashelf.dev/templates/style.css" />
        <!-- Begin Lineicons import -->
    <link rel="stylesheet" href="https://cdn.lineicons.com/5.0/lineicons.css" />
    <!-- End Lineicons import-->
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="shortcut icon"
      href="/assets/favicon-96x96.png"
      type="image/x-icon"
    />
  </head>
  <body>
    <header class="page-navigation">
      <nav class="primary-buttons">
        <ul>
          <li><a class="nav-button" href="/">Index</a></li>
        </ul>
      </nav>
      <nav class="secondary-buttons">
        <ul>
          <li>
            <a class="nav-button" href="/pages/posts.html"> Posts </a>
            <a class="nav-button" href="/pages/about.html"> About </a>
            <a class="nav-button" href="/pages/privacy.html"> Privacy </a>
          </li>
        </ul>
      </nav>
    </header>
    <hr class="nav-border">

    <main>
      <!-- Keywords, if any. -->
      

      <!-- Table of Contents, if enabled -->
       <h1
id="when-why-and-how-to-extend-nixpkgs-standard-library">When, Why and
How to Extend Nixpkgs Standard Library</h1>
<div class="reading-time">
<p>3 minute read</p>
</div>
<p>In plenty of cases, you might need to write your own custom functions
and store them somewhere. While it is conceptually possible and easy to
define them inside an argument you might want to stick in for example
<code>specialArgs</code> in the context of a NixOS configuration, there
are easier and more ergonomic ways of doing so.</p>
<h2 id="what-is-nixpkgslib" id="what-is-nixpkgslib">What is
<code>nixpkgs.lib</code> <a href="#what-is-nixpkgslib" class="anchor-link">üîó</a></h2>
<p>In the context of Nix/OS, <code>nixpkgs.lib</code> refers to a module
within the Nixpkgs repository that acts as a collection of helpful
functions and other utilities designed around usage in Nixpkgs and by
extension NixOS configurations.We often use those functions to simplify
our configurations and the Nix package build processes. It is available
as a top-level attribute as <code>nixpkgs.lib</code>, but also inside
<code>pkgs</code> as <code>pkgs.lib</code>. While using
<code>lib.nixosSystem</code>, it is also added to your system‚Äôs
<code>specialArgs</code><a href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a> so that you can add it to the
argument set (i.e. the line that goes <code>{pkgs, lib, ...}</code> at
the top of a file) in your NixOS configuration easily.</p>
<h2 id="why-would-you-need-to-extend-nixpkgslib"
id="why-would-you-need-to-extend-nixpkgslib">Why would you need to
extend
<code>nixpkgs.lib</code> <a href="#why-would-you-need-to-extend-nixpkgslib" class="anchor-link">üîó</a></h2>
<p>While the library functions provided by nixpkgs is quite extensive
and usually suits my needs, I sometimes feel the need to define my own
function or wrap an existing function to complete a task. Normally we
can handle the process of a function inside a simple <code>let in</code>
and be well off, but there may be times you need to re-use the existing
function across your configuration file. In such times, you might want
to either write your own lib and inherit it at the source of your
<code>flake.nix</code> to then inherit them across your
configuration.</p>
<h2 id="extending-nixpkgslib" id="extending-nixpkgslib">Extending
<code>nixpkgs.lib</code> <a href="#extending-nixpkgslib" class="anchor-link">üîó</a></h2>
<p>I find the easiest way of extending nixpkgs.lib to be using an
‚Äúoverlay‚Äù, enabled by <code>makeExtensible</code>. <a href="#fn2"
class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The file path is arbitrary, let&#39;s assume that this is in</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lib/default.nix for the sake of simplicity.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span><span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>: inputs.nixpkgs.lib.extend <span class="op">(</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">final</span><span class="op">:</span> <span class="va">prev</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Your functions go here</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">)</span></span></code></pre></div>
<p>The above structure takes the existing <code>lib</code> from
<code>nixpkgs</code>, which you‚Äôll remember is defined as
<code>nixpkgs.lib</code>, and appends your own extensions to it. You may
then import this library in your <code>flake.nix</code> to pass it to
other imports and definitions.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flake.nix</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>flake = <span class="kw">let</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the extended lib form ./lib/default.nix</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">lib</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./lib</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs<span class="op">;};</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then you may pass it around, e.g. in imports by adding `lib`</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># to the argument set.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">nixosConfigurations</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./hosts</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs self lib<span class="op">;};</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>In this example, the extended library is imported from
<code>lib/default.nix</code> in repository root where the overlay is
defined. It is then passed around to make the extended <code>lib</code>
available within all files called by <code>flake.nix</code>. For
example, in <code>hosts/default.nix</code> it could be added to
<code>specialArgs</code> to make the extended library the default in a
NixOS configuration.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hosts/default.nix</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span><span class="va">lib</span><span class="op">,</span> <span class="op">...}</span>: <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Since this is called by nixosConfigurations = ./import ...</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we just add the configuration attributes here, one for each</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># new configuration.</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">fooSystem</span> <span class="op">=</span> lib.nixosSystem <span class="op">{</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span> ... <span class="op">];</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">specialArgs</span> <span class="op">=</span> <span class="op">{</span><span class="va">lib</span><span class="op">;};</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p>Now any and all new functions defined in the extended library will
become available in any files called by <code>modules</code>, thanks to
<code>specialArgs</code>.</p>
<h2 id="caveats"
id="caveats">Caveats <a href="#caveats" class="anchor-link">üîó</a></h2>
<p>The problem with this approach is that it may be confusing for other
people reviewing your configuration. With this approach,
<code>lib.customFunction</code> looks identical to any lib function,
which may lead to people thinking the function exists in nixpkgs itself
while it is only provided by your configuration. This is not a problem
per se, but if this is something that bothers you then the solution is
simple though. Instead of extending <code>nixpkgs.lib</code>, you may
define your own lib that does not inherit from <code>nixpkgs.lib</code>
and only contains your functions. The process would be similar, and you
would not need to define an overlay.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flake.nix</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>flake = <span class="kw">let</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extended nixpkgs lib, contains my custom functions</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">lib&#39;</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./lib</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs lib inputs<span class="op">;};</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># entry-point for nixos configurations</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixosConfigurations</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./hosts</span> <span class="op">{</span><span class="kw">inherit</span> nixpkgs self lib&#39;<span class="op">;};</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>where your <code>lib/default.nix</code> looks like</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lib/default.nix</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span><span class="va">nixpkgs</span><span class="op">,</span> <span class="op">...}</span>: <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define your functions here as you would do in an extension</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="example-implementations" id="example-implementations">Example
Implementations <a href="#example-implementations" class="anchor-link">üîó</a></h2>
<p>If you have defined your own custom library based on this post, feel
free to add a project or your configuration as an example here.</p>
<ul>
<li><a
href="https://github.com/NotAShelf/nvf/blob/main/lib/stdlib-extended.nix">nvf‚Äôs
extended library</a></li>
<li><a
href="https://github.com/snugnug/micros/blob/50db7e1c8e1633566c43190976bf2f6ac43f12ff/flake.nix#L86">MicrOS</a></li>
</ul>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p><a
href="https://github.com/NixOS/nixpkgs/blob/03ae77ee2d193531819ae43711c8f168c7051e7b/nixos/lib/eval-config.nix#L32">https://github.com/NixOS/nixpkgs/blob/03ae77ee2d193531819ae43711c8f168c7051e7b/nixos/lib/eval-config.nix#L32</a><a
href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p><a
href="https://github.com/NixOS/nixpkgs/blob/03ae77ee2d193531819ae43711c8f168c7051e7b/lib/default.nix#L10C9-L10C22">https://github.com/NixOS/nixpkgs/blob/03ae77ee2d193531819ae43711c8f168c7051e7b/lib/default.nix#L10C9-L10C22</a><a
href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section> 
    </main>
    <footer>
      <div class="footer-divider"></div>
      <p>&copy; <span id="copyright"></span> NotAShelf</p>
      <div class="footer-icons">
        <a href="https://github.com/notashelf">
          <i class="lni lni-github" title="GitHub"></i>
        </a>
      </div>
    </footer>
    <script defer src="/static/copyright.js"</script>
    <script
        defer
      data-domain="blog.notashelf.dev"
      src="https://pl.notashelf.dev/js/script.file-downloads.hash.outbound-links.tagged-events.js"
    ></script>
    <script>
      window.plausible =
        window.plausible ||
        function () {
          (window.plausible.q = window.plausible.q || []).push(arguments);
        };
    </script>

        </body>
</html>
