<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/assets/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/assets/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/assets/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/assets/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/assets/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/assets/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/assets/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/assets/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/assets/android-icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/assets/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
         <meta name="dcterms.date" content="2024-05-11" />
          <meta name="description" content="Notes on Nix, Linux and every other pie I put a finger in" />
        <title>Posts - On Sysrq</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #232629;
          color: #7a7c7d;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
      div.sourceCode
        { color: #cfcfc2;  }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #cfcfc2; } /* Normal */
      code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
      code span.an { color: #3f8058; } /* Annotation */
      code span.at { color: #2980b9; } /* Attribute */
      code span.bn { color: #f67400; } /* BaseN */
      code span.bu { color: #7f8c8d; } /* BuiltIn */
      code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #3daee9; } /* Char */
      code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
      code span.co { color: #7a7c7d; } /* Comment */
      code span.cv { color: #7f8c8d; } /* CommentVar */
      code span.do { color: #a43340; } /* Documentation */
      code span.dt { color: #2980b9; } /* DataType */
      code span.dv { color: #f67400; } /* DecVal */
      code span.er { color: #da4453; text-decoration: underline; } /* Error */
      code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
      code span.fl { color: #f67400; } /* Float */
      code span.fu { color: #8e44ad; } /* Function */
      code span.im { color: #27ae60; } /* Import */
      code span.in { color: #c45b00; } /* Information */
      code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
      code span.op { color: #cfcfc2; } /* Operator */
      code span.ot { color: #27ae60; } /* Other */
      code span.pp { color: #27ae60; } /* Preprocessor */
      code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
      code span.sc { color: #3daee9; } /* SpecialChar */
      code span.ss { color: #da4453; } /* SpecialString */
      code span.st { color: #f44f4f; } /* String */
      code span.va { color: #27aeae; } /* Variable */
      code span.vs { color: #da4453; } /* VerbatimString */
      code span.wa { color: #da4453; } /* Warning */
    </style>
        <link rel="stylesheet" href="/home/runner/work/blog.notashelf.dev/blog.notashelf.dev/templates/style.css" />
        <!-- Begin Lineicons import -->
    <link rel="stylesheet" href="https://cdn.lineicons.com/4.0/lineicons.css" />
    <!-- End Lineicons import-->
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="shortcut icon"
      href="/assets/favicon-96x96.png"
      type="image/x-icon"
    />
  </head>
  <body>
    <header>
      <nav class="primary-buttons">
        <ul>
          <li><a class="nav-button" href="/">Index</a></li>
        </ul>
      </nav>
      <nav class="secondary-buttons">
        <ul>
          <li>
            <a class="nav-button" href="/pages/posts.html"> Posts </a>
            <a class="nav-button" href="/pages/about.html"> About </a>
            <a class="nav-button" href="/pages/privacy.html"> Privacy </a>
          </li>
        </ul>
      </nav>
    </header>

    <main>
      <!-- Keywords, if any. -->
      

      <!-- Table of Contents, if enabled -->
       <h1 id="on-sysrq">On SysRq</h1>
<h2 id="resources">Resources</h2>
<ul>
<li><a
href="https://wiki.archlinux.org/title/keyboard_shortcuts">https://wiki.archlinux.org/title/keyboard_shortcuts</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Magic_SysRq_key">https://en.wikipedia.org/wiki/Magic_SysRq_key</a></li>
<li><a
href="https://docs.kernel.org/admin-guide/sysrq.html">https://docs.kernel.org/admin-guide/sysrq.html</a></li>
<li><a
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/admin-guide/sysrq.rst">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/admin-guide/sysrq.rst</a></li>
</ul>
<h2 id="what-is-sysrq">What is SysRq?</h2>
<p>SysRq is a "<em>magical</em>"<a href="#fn1" class="footnote-ref"
id="fnref1" role="doc-noteref"><sup>1</sup></a> key combination, or
possibly a literal key on your keyboard that is understood by the Linux
kernel, which allows you to perform various low-level commands
regardless of the system's current state. Some Linux-first computer
manufacturers may include a literal SysRq key, or chances are your PrtSc
key (located somewhat close to your Numpad) doubles as it.</p>
<h2 id="what-can-i-do-with-it">What can I do with it?</h2>
<p>SysRq is most often used to recover from and debug an unresponsive
system, especially if you are trying to avoid doing a hard shutdown -
which could potentially cause data corruption - and is recommended over
a hard shutdown. Using the SysRq key, you can communicate with the Linux
kernel directly and reboot your <em>correctly</em>, without potentially
nuking active disk writes.</p>
<h2 id="how-do-i-use-sysrq">How do I use SysRq?</h2>
<p>You should first check if your system is configured to support SysRq.
Some distros and users (such as myself) decide to disable SysRq because
it is a potential security flaw.</p>
<p>To check whether your system is allowed to use SysRq, simply run</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /proc/sys/kernel/sysrq</span></code></pre></div>
<p>and you will receive a value that describes the functionality of your
SysRq key, or whether or not it is allowed.</p>
<h3 id="possible-values">Possible Values</h3>
<p>The <a href="https://docs.kernel.org/admin-guide/sysrq.html">kernel
documentation</a> gives you a neat list of values and what they
allow.</p>
<table>
<thead>
<tr class="header">
<th>Value</th>
<th>Bitmask</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0x0</td>
<td>disable sysrq completely</td>
</tr>
<tr class="even">
<td>1</td>
<td>0x1</td>
<td>enable all functions of sysrq</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0x2</td>
<td>enable control of console logging level</td>
</tr>
<tr class="even">
<td>4</td>
<td>0x4</td>
<td>enable control of keyboard (SAK, unraw)</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0x8</td>
<td>enable debugging dumps of processes etc</td>
</tr>
<tr class="even">
<td>16</td>
<td>0x10</td>
<td>enable sync command</td>
</tr>
<tr class="odd">
<td>32</td>
<td>0x20</td>
<td>enable remount read-only</td>
</tr>
<tr class="even">
<td>64</td>
<td>0x40</td>
<td>enable signalling of processes (term, kill, oom-kill)</td>
</tr>
<tr class="odd">
<td>128</td>
<td>0x80</td>
<td>allow reboot/poweroff</td>
</tr>
<tr class="even">
<td>256</td>
<td>0x100</td>
<td>allow nicing of all RT tasks</td>
</tr>
</tbody>
</table>
<h3 id="setting-sysrq-bitmask">Setting SysRq Bitmask</h3>
<p>You can set SysRq to <code>0</code> in order to disable it,
<code>1</code> to allow ALL functionality and to a value
<code>&gt;= 1</code> to set a bitmask<a href="#fn2" class="footnote-ref"
id="fnref2" role="doc-noteref"><sup>2</sup></a> of allowed SysRq
functions.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;number&quot;</span> <span class="op">&gt;</span>/proc/sys/kernel/sysrq</span></code></pre></div>
<p>To combine different functionalities in the SysRq permission bitmap,
you will need to perform bitwise OR operations on the values
corresponding to the functionalities you want to enable. Each
functionality corresponds to a specific bit in the bitmap.</p>
<p>E.g., let's say you want to enable the functionalities for
controlling console logging level <code>(0x2)</code>, enabling sync
command <code>(0x10)</code>, and allowing reboot/poweroff
<code>(0x80)</code>. To combine these functionalities:</p>
<pre><code>0x2 (console logging level) | 0x10 (sync command) | 0x80 (reboot/poweroff)</code></pre>
<p>Which would perform the following bitwise OR operation:</p>
<pre><code>0x2 | 0x10 | 0x80 = 0x92</code></pre>
<p>This <strong>hexadecimal</strong> value would then be converted to
<strong>decimal</strong> (which the kernel commandline expects) as
<code>146.</code> Therefore you would run the following command to set
your desired bitmask:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> 146 <span class="op">&gt;</span> /proc/sys/kernel/sysrq</span></code></pre></div>
<h3 id="persisting-sysrq">Persisting SysRq</h3>
<p>You can enable <code>SysRq</code> with one command, as described
above. Do keep in mind that running e.g.
<code>echo 1 &gt; /proc/sys/kernel/sysrq</code> will enable SysRq only
until reboot and its state will not persist across reboots.</p>
<p>On traditional distros, you can make it persistent by adding
<code>"kernel.sysrq = 1"</code> at the end of
<code>/etc/sysctl.d/99-sysctl.conf</code>.</p>
<p>On NixOS, you will need to set
<code>boot.kernel.sysctl."kernel.sysrq" = 1;</code> in your
<code>configuration.nix</code>. In some cases, you might need to
<em>force</em> this value in case it is being overridden:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>boot.kernel.sysctl.<span class="st">&quot;kernel.sysrq&quot;</span> = lib.mkForce <span class="dv">1</span>;</span></code></pre></div>
<h2 id="useful-applications-of-sysrq">Useful applications of SysRq</h2>
<p>There are various applications of SysRq based on the bitmask range it
was allowed. Below are the two most common ones that I came across.</p>
<h3 id="rebooting-with-sysrq">Rebooting with SysRq</h3>
<p>Earlier I have mentioned that SysRq is often used to perform a proper
reboot and to recover a frozen system. With a permissive enough<a
href="#fn3" class="footnote-ref" id="fnref3"
role="doc-noteref"><sup>3</sup></a> bitmask, you can use the following
idiom: "Reboot Even If System Utterly Broken" (also referred to as
"REISUB").</p>
<ul>
<li>R: Turns off keyboard raw mode, and sets it to XLATE.</li>
<li>E: Send a SIGTERM to all processes, except for init.</li>
<li>I: Send a SIGKILL to all processes, except for init.</li>
<li>S: Will attempt to sync all mounted filesystems.</li>
<li>U: Will attempt to re-mount all mounted filesystems as
read-only.</li>
<li>B: Reboot!</li>
</ul>
<blockquote>
<p>Please be aware that "REISUB" itself is just a mnemonic, not any kind
of general recommendation for the key press sequence to take back
control of an unresponsive system. You should not blindly press these
sequences each time without knowing their actual function as noted
below<a href="#fn4" class="footnote-ref" id="fnref4"
role="doc-noteref"><sup>4</sup></a></p>
</blockquote>
<p>To do this on your system, you what you need to do is to hold down
the <code>ALT</code> key and the <code>SysRq</code> keys at the same
time, hit the next queued letter while holding the key combination, and
then release. Repeat this for each letter (command) in the idiom. To
summarize, running the <code>REISUB</code> sequence would require you to
hold down <code>ALT + SysRq</code> 6 <strong>separate</strong> times</p>
<h3 id="invoking-oom-killer">Invoking OOM Killer</h3>
<p>SysRq can also be used to invoke the OOM (out-of-memory) killer
without causing a kernel panic if there is nothing to kill. If your
system is frozen due to intense memory pressure, this could be an useful
way to quickly get yourself out of a status that might corrupt your
data. Simply run <code>ALT + SysRq + f</code> and hope that OOM killer
picks something recoverable.</p>
<blockquote>
<p>Keep in mind that the OOM killer, despite its well-meaning
heuristics, can be unpredictable and lead to irreversible damage. Do not
use this key combination casually.</p>
</blockquote>
<h2 id="is-sysrq-worth-it">Is SysRq worth it?</h2>
<p>Those who have gone through my system configuration might have
noticed that I force SysRq to be disabled with <code>kernel.sysrq</code>
set to <code>0</code>.</p>
<p>That is because I never had the need to use SysRq. After years on
Linux, I never had to recover from a system freezing over a long
duration. It either lives, or it dies. Recently I have configured OOM
killer daemon to automatically kill useless applications such as
Electron, that tend to drain my memory - especially on low-end systems
because despite what devs might say, <strong>electron still
sucks</strong>. As such, I do not think that SysRq is worth the
potential security flaw right, but that question is for you to answer
yourself.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Quite literally what it is called in the <a
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/admin-guide/sysrq.rst">kernel
documentation</a><a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The permission bitmap is a 32-bit bitmap that determines
which SysRq commands are allowed to be executed. Each bit in the bitmap
corresponds to a specific SysRq command. When a SysRq command is issued,
the kernel checks the corresponding bit in the permission bitmap to
determine whether the command is allowed or not.<a href="#fnref2"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The whole set of <code>REISUB</code> functions can be
enabled by setting SysRq value to 244, although this will also enable
additional functions which some may find undesirable. If in doubt, do
the math and choose your bitmask range yourself.<a href="#fnref3"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p><a
href="https://wiki.archlinux.org/title/keyboard_shortcuts#Rebooting">Archwiki
on SysRq</a><a href="#fnref4" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
</ol>
</section> 
    </main>
    <footer>
      <div class="footer-divider"></div>
      <p>&copy; <span id="copyright"></span> NotAShelf</p>
      <div class="footer-icons">
        <a href="https://github.com/notashelf">
          <i class="lni lni-github-original" title="GitHub"></i>
        </a>
      </div>
    </footer>
    <script src="/static/copyright.js"</script>
  </body>
</html>
