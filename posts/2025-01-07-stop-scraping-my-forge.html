<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/assets/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/assets/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/assets/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/assets/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/assets/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/assets/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/assets/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/assets/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/assets/android-icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/assets/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
         <meta name="dcterms.date" content="2025-01-07" />
          <meta name="description" content="Notes on Nix, Linux and every other pie I put a finger in" />
        <title>Posts - Stop Scraping My Forge</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #232629;
          color: #7a7c7d;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
      div.sourceCode
        { color: #cfcfc2;  }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #cfcfc2; } /* Normal */
      code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
      code span.an { color: #3f8058; } /* Annotation */
      code span.at { color: #2980b9; } /* Attribute */
      code span.bn { color: #f67400; } /* BaseN */
      code span.bu { color: #7f8c8d; } /* BuiltIn */
      code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #3daee9; } /* Char */
      code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
      code span.co { color: #7a7c7d; } /* Comment */
      code span.cv { color: #7f8c8d; } /* CommentVar */
      code span.do { color: #a43340; } /* Documentation */
      code span.dt { color: #2980b9; } /* DataType */
      code span.dv { color: #f67400; } /* DecVal */
      code span.er { color: #da4453; text-decoration: underline; } /* Error */
      code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
      code span.fl { color: #f67400; } /* Float */
      code span.fu { color: #8e44ad; } /* Function */
      code span.im { color: #27ae60; } /* Import */
      code span.in { color: #c45b00; } /* Information */
      code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
      code span.op { color: #cfcfc2; } /* Operator */
      code span.ot { color: #27ae60; } /* Other */
      code span.pp { color: #27ae60; } /* Preprocessor */
      code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
      code span.sc { color: #3daee9; } /* SpecialChar */
      code span.ss { color: #da4453; } /* SpecialString */
      code span.st { color: #f44f4f; } /* String */
      code span.va { color: #27aeae; } /* Variable */
      code span.vs { color: #da4453; } /* VerbatimString */
      code span.wa { color: #da4453; } /* Warning */
    </style>
        <link rel="stylesheet" href="/home/runner/work/blog.notashelf.dev/blog.notashelf.dev/templates/style.css" />
        <!-- Begin Lineicons import -->
    <link rel="stylesheet" href="https://cdn.lineicons.com/4.0/lineicons.css" />
    <!-- End Lineicons import-->
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="shortcut icon"
      href="/assets/favicon-96x96.png"
      type="image/x-icon"
    />
  </head>
  <body>
    <header class="page-navigation">
      <nav class="primary-buttons">
        <ul>
          <li><a class="nav-button" href="/">Index</a></li>
        </ul>
      </nav>
      <nav class="secondary-buttons">
        <ul>
          <li>
            <a class="nav-button" href="/pages/posts.html"> Posts </a>
            <a class="nav-button" href="/pages/about.html"> About </a>
            <a class="nav-button" href="/pages/privacy.html"> Privacy </a>
          </li>
        </ul>
      </nav>
    </header>
    <hr class="nav-border">

    <main>
      <!-- Keywords, if any. -->
      

      <!-- Table of Contents, if enabled -->
       <h1 id="stop-scraping-my-git-forge">Stop Scraping my Git
Forge!</h1>
<div class="reading-time">
<p>4 minute read</p>
</div>
<p>Not so long ago, while performing maintenance on my VPS and setting
up Prometheus, Grafana, and related tools, I noticed something
unexpected yet not entirely surprising. My Nginx instance was under
constant bombardment of requests from a specific subnet. Public-facing
servers are no strangers to port scans, but the intensity and
specificity, but the frequency of these requests caught my attention and
prompted me to investigate further.</p>
<h2 id="hello-old-friend" id="hello-old-friend">Hello, Old
Friend <a href="#hello-old-friend" class="anchor-link">🔗</a></h2>
<p>I have parted ways with Facebook before its acquisition of Instagram.
I hate both of those platforms and the constant infringement of privacy
they curse us with. You understand my surprise when I looked at my Nginx
webserver log and found <em>thousands</em> of requests coming my way;
all with the user agent <code>facebookexternalhit</code>. More
specifically, they were sending <code>GET</code> requests to <em>my
personal Git forge</em>—a service where I store <em>personal</em>
projects that I prefer not to entrust platforms Microsoft Github. Over
<strong>30,000</strong> lines were reserved to nothing but unsolicited
<code>GET</code> requests in my access log. <strong>What the
hell</strong>?</p>
<p>Instinctively, I put together a quick Python script that follows the
service logs for Forgejo, which at the time also logged router events,
and logs <em>unique</em> IPs to a single file so that I can ban those
IPs with firewall rules, using the trusty nftables.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>logfile <span class="op">=</span> <span class="st">&quot;unique_ips.log&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>ipv4_pattern <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r&quot;\b(?:[0-9]{1,3}\.)</span><span class="sc">{3}</span><span class="vs">[0-9]{1,3}\b&quot;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_logged_ips():</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(logfile, <span class="st">&quot;r&quot;</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">set</span>(<span class="bu">file</span>.read().splitlines())</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">set</span>()</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_ip(ip, timestamp, logged_ips):</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(logfile, <span class="st">&quot;a&quot;</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.write(<span class="ss">f&quot;</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>ip<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    logged_ips.add(ip)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    logged_ips <span class="op">=</span> read_logged_ips()</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    process <span class="op">=</span> subprocess.Popen(</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        [<span class="st">&quot;journalctl&quot;</span>, <span class="st">&quot;-xeu&quot;</span>, <span class="st">&quot;forgejo.service&quot;</span>, <span class="st">&quot;-f&quot;</span>],</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        stdout<span class="op">=</span>subprocess.PIPE,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        stderr<span class="op">=</span>subprocess.PIPE,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        line <span class="op">=</span> process.stdout.readline()</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&quot;404 Not Found&quot;</span> <span class="kw">in</span> line:</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>            ip_match <span class="op">=</span> ipv4_pattern.search(line)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ip_match:</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>                ip <span class="op">=</span> ip_match.group()</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> ip <span class="kw">not</span> <span class="kw">in</span> logged_ips:</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>                    timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S&quot;</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                    log_ip(ip, timestamp, logged_ips)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;Logged new IP: </span><span class="sc">{</span>ip<span class="sc">}</span><span class="ss"> at </span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div>
<p>I left the script, aptly and unimaginatively named
<code>catch.py</code> running for around an hour while I went to fix a
nice meal for myself— which you need to deal with Meta’s bullshit. When
I came back, there were hundreds of <em>unique</em> IPs in the logfile.
Not a handful, <em>hundreds</em>. Not only that, but they were coming
from several different subnets. This means</p>
<ol type="1">
<li>Meta is using several different providers (as evident from IP
queries) to simply send bogus requests to people’s webservers.</li>
<li>Meta is, in fact, <em>not</em> respecting <code>robots.txt</code>.<a
href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a></li>
<li>They feel not at all inclined to maybe stop and think sending
thousands of to people’s servers is malicious.</li>
<li>To my demise, banning each and every single one of those subnets
would take too long, and block possibly legitimate traffic.</li>
</ol>
<h2 id="get-out-of-my-lawn" id="get-out-of-my-lawn">Get Out of My
Lawn <a href="#get-out-of-my-lawn" class="anchor-link">🔗</a></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fl">57.141.0.16</span> <span class="op">-</span> <span class="op">-</span> [<span class="dv">22</span><span class="op">/</span>Nov<span class="op">/</span><span class="dv">2024</span><span class="op">:</span><span class="dv">00</span><span class="op">:</span><span class="dv">36</span><span class="op">:</span><span class="dv">29</span> <span class="op">+</span><span class="bn">0300</span>] <span class="st">&quot;GET /NotAShelf/nyx/commits/commit/4c82e5ee05fabd315a6e5c656fd72e11c93c4cfd/homes/notashelf/services/wayland/hyprpaper HTTP/2.0&quot;</span> <span class="dv">403</span> <span class="dv">146</span> <span class="st">&quot;-&quot;</span> <span class="st">&quot;meta-externalagent/1.1 (+https://developers.facebook.com/docs/sharing/webmasters/crawler)&quot;</span></span></code></pre></div>
<p>Here is an example of a request from my webserver logs. Take a look
at the body. They are scraping my <em>NixOS configuration</em> that is
available on my Git forge and they are doing it <strong>commit by
commit</strong>.</p>
<p>Following this unfortunate encounter, I have decided to start
blocking any requests coming with <code>meta-externalagent*</code> as
their user agent. Such requests now receive a 403 Forbidden response as
per my adjusted Nginx configuration.</p>
<pre class="nginx"><code># Define access and error log paths.
access_log /var/log/nginx/forgejo_access.log;
error_log /var/log/nginx/forgejo_error.log;

# Tell Facebook&#39;s crawlers to fuck right off.
if ($http_user_agent ~* &quot;^meta-externalagent(/[\d\.]+)?$&quot;) {
  return 403;
}

if ($http_user_agent ~* &quot;^facebookexternalhit(/[\d\.]+)?$&quot;) {
  return 403;
}</code></pre>
<p>Okay, surely this will work. There is no way that a webcrawler is
designed badly or maliciously enough to disregard hundreds of error
response 403s, indicating that they are <a
href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403">forbidden
from</a> accessing that URL. Surely?</p>
<p>Here is a request from today, shortly after I started writing this
post.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fl">57.141.0.17</span> <span class="op">-</span> <span class="op">-</span> [<span class="bn">07</span><span class="op">/</span>Jan<span class="op">/</span><span class="dv">2025</span><span class="op">:</span><span class="dv">13</span><span class="op">:</span><span class="dv">12</span><span class="op">:</span><span class="bn">06</span> <span class="op">+</span><span class="bn">0300</span>] <span class="st">&quot;GET /NotAShelf/nyx/raw/commit/93d16a3edbaa8177c76ed84c4c5b489649faa609/modules/common/options/default.nix HTTP/2.0&quot;</span> <span class="dv">403</span> <span class="dv">146</span> <span class="st">&quot;-&quot;</span> <span class="st">&quot;meta-externalagent/1.1 (+https://developers.facebook.com/docs/sharing/webmasters/crawler)&quot;</span></span></code></pre></div>
<p>At this point, I am not sure if this incompetence or plain
stupidity.</p>
<h2 id="ban-them-all" id="ban-them-all">Ban Them
All <a href="#ban-them-all" class="anchor-link">🔗</a></h2>
<p>This has been <del>yet another</del> a technical rant and a gentle
nudge to you that you should check <em>your</em> webserver logs to see
if your content is being scraped for, well, as long as it has been
online.</p>
<p>My Forgejo instance is now inaccessible to those who have not logged
in—even for public repositories— and my Nginx configuration responds
with 403 to any requests coming from Meta’s known crawlers. I have also
tried sending an-email to their webmaster as listed from the
documentation URL attached to their crawlers, but I am yet to receive a
response, or to see an indication of those crawlers stopping soon.
Meanwhile, I am left to deal with their recklessness on my own
accord.</p>
<p>Instead, I will resort to banning ALL of them with nftables using IP
ranges. It is going to be annoying, but not fruitless, to write another
Python script to identify <em>each and every single subnet</em> those
requests are coming from. Once I have a list, it will be trivial to
draft the rule. I suggest that you do the same.</p>
<p>Stay safe.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Meta’s own web-crawler documentation indicates that they
may choose to disregard your <code>robots.txt</code> if they are
performing “integrity or security checks” which in truth is just a vague
way to say that you may sometimes decide to <em>not</em> play by the
rules. At this point your bet is banning them by IP range, which turns
out to be listed in the <a
href="https://developers.facebook.com/docs/sharing/webmasters/web-crawlers">very
same documentation</a> as the result of the command
<code>whois -h whois.radb.net -- '-i origin AS32934' | grep ^route</code>.
Naturally, I do not trust the information granted “graciously” by Meta,
so I will be investigating my logfiles carefully to find if there is any
more.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
</ol>
</section> 
    </main>
    <footer>
      <div class="footer-divider"></div>
      <p>&copy; <span id="copyright"></span> NotAShelf</p>
      <div class="footer-icons">
        <a href="https://github.com/notashelf">
          <i class="lni lni-github-original" title="GitHub"></i>
        </a>
      </div>
    </footer>
    <script src="/static/copyright.js"</script>
  </body>
</html>
